<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Leitura de Arquivos e Registros Exclusivos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Adicionando estilos do Monaco Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.min.css">
    <style>
        body {
            background-color: #1e1e1e; /* Cor de fundo escura para o tema escuro */
            color: #ffffff; /* Cor do texto clara para o tema escuro */
            margin-bottom: 150px; /* Adicione uma margem inferior igual à altura do seu footer */
        }
        .footer {
            text-align: center;
            position: absolute;
            bottom: -50%;
            left: 0;
            width: 100%;
            height: 100px;
            line-height: 100px;
            background-color: rgba(0, 0, 0, 0.1); /* Cor de fundo com transparência */
            color: #fff;
        }
        #logTextArea {
            height: 150px; /* Ajuste a altura conforme necessário */
        }
    </style>
</head>
<body class="bg-dark text-light">

<main class="main">
<div class="container mt-5">
    <h2 class="mb-4">Leitura de Arquivos e Registros Exclusivos</h2>

    <form id="fileForm" >
        <div class="mb-3">
            <label for="fileInput" class="form-label">Escolha arquivos do mesmo tipo:</label>
            <input type="file" class="form-control" id="fileInput" accept="*" multiple required>
        </div>

        <button id="processFilesButton" type="button" class="btn btn-primary" onclick="processFiles()">Processar Arquivos</button>
    </form>

    <div class="mt-4">
        <label for="resultTextarea" class="form-label">Registros Exclusivos:</label>
        <!-- Adicionando o editor Monaco -->
        <div id="editor" style="height: 300px;"></div>
    </div>

    <!-- Adicionando a informação de quantas linhas distintas foram processadas -->
    <p id="lineCount" class="mt-3"></p>

    <!-- Adicionando o textarea de log -->
    <label for="logTextArea" class="form-label mt-3">Log de Processamento:</label>
    <textarea id="logTextArea" class="form-control" disabled></textarea>
</div><br>
<footer class="footer">
    <p id="copyright">© Starley Interface 2017 - <span id="anoAtual"></span> | Versão 1.0.0</p>
</footer>
</main>
<script>
    // Obtém o ano atual
    var anoAtual = new Date().getFullYear();

    // Define o texto do elemento com o id "anoAtual"
    document.getElementById('anoAtual').innerHTML = anoAtual;
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Adicionando scripts do Monaco Editor -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
<script>
    function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const editor = monaco.editor.getModels()[0];
        const logTextArea = document.getElementById('logTextArea');
		const processFilesButton = document.getElementById('processFilesButton');
        const files = fileInput.files;
		
		if (files.length === 0) {
            alert('Selecione pelo menos um arquivo.');
			// Restaura a cor e o texto original do botão
			processFilesButton.style.backgroundColor = '';
			processFilesButton.style.color = '';
			processFilesButton.innerText = 'Processar Arquivos';
            return;
        }
		
		// Mude a cor do botão para verde e altere o texto
		processFilesButton.style.backgroundColor = 'green';
		processFilesButton.innerText = 'Processando arquivos...';

        const filePromises = Array.from(files).map(file => readFile(file, logTextArea));

        Promise.all(filePromises)
            .then(results => {
                // Concatena todos os resultados em uma única array
                const allLines = results.flat();

                // Remove espaços em branco e duplicatas
                const uniqueRecords = [...new Set(allLines.map(line => line.trim()))];

                // Defina o conteúdo do editor com os registros exclusivos
                editor.setValue(uniqueRecords.join('\n'));

                // Atualiza a informação de quantas linhas distintas foram processadas
                document.getElementById('lineCount').innerText = `Total de Linhas Distintas: ${uniqueRecords.length - 1}`;
				
				// Restaura a cor e o texto original do botão
				processFilesButton.style.backgroundColor = '';
				processFilesButton.innerText = 'Processar Arquivos';
            })
            .catch(error => {
                console.error('Erro ao processar arquivos:', error);
            });
    }

    function readFile(file, logTextArea) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = function (e) {
                const content = e.target.result;

                // Substitui dois ou mais espaços por um espaço, incluindo espaços entre aspas
                const cleanedContent = content.replace(/ {2,}|\s{2,}("|')/g, ' $1');

                const lines = cleanedContent.split('\n');

                // Log de processamento linha a linha
                lines.forEach(line => {
                    logTextArea.value += `Lendo arquivo ${file.name}, registro: ${line}\n`;
                });

                resolve(lines);
            };

            reader.onerror = function (e) {
                reject(e);
            };

            reader.readAsText(file);
        });
    }

    // Carregue o editor Monaco
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
        // Crie um editor Monaco com tema escuro
        monaco.editor.create(document.getElementById('editor'), {
            language: 'plaintext',
            automaticLayout: true,
            lineNumbers: "on",
            theme: "vs-dark" // Modo escuro
        });
    });
</script>

</body>
</html>
