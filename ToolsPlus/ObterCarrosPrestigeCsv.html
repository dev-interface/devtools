<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON para CSV - Múltiplos Arquivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Ícones Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <!-- Script Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
	
        /* Estilo do corpo, ajuste para modo escuro */
        body {
			-webkit-text-size-adjust: none;
			text-size-adjust: none;
            background-color: #1e1e1e;
            color: #ffffff;
            margin-bottom: 150px;
			transition: color 0.3s ease; /* Transição suave para a cor do link */
        }
		
        /* Estilo do cabeçalho */
        header {
            display: flex;
            justify-content: flex-end; /* Alinha os botões à direita */
            margin-bottom: -20px; /* Espaçamento entre o cabeçalho e o restante do conteúdo */
			margin-right: 10px;
			margin-top: 30px;
        }
		
		.seletor {
			text-align: match-parent;
		}


        /* Estilo do footer */
        .footer {
            text-align: center;
            position: absolute;
            bottom: -100%;
            left: 0;
            width: 100%;
            height: 100px;
            line-height: 100px;
            background-color: rgba(0, 0, 0, 0.1);
            color: #fff;
        }

        #resCsv {
            height: 400px;
            /* Ajuste a altura conforme necessário */
        }

        /* Estilo do botão de alternância de tema */
        #toggleThemeButton {
            margin-right: 10px; /* Espaçamento à direita do botão */
        }
		
		/* Classe para links escuros no tema claro */
		.link-dark {
			color: #000 !important; /* Preto */
		}
		
		/* Cor do link ao passar o mouse por cima */
		.link-dark:hover {
			color: blue; /* Azul ao passar o mouse */
		}
		

		
    </style>
    <!-- CDN para Monaco Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script> <!-- Inclua JSZip para descompactar ZIP -->
</head>

<body class="bg-dark text-light">
<!-- Cabeçalho com os botões de acessibilidade, daltonismo e alternância de tema -->
    <header>
        <button title="accessibilityButton" id="accessibilityButton" class="btn btn-secondary" onclick="toggleAccessibility()">Acessibilidade</button>
        <select title="colorBlindSelect" id="colorBlindSelect" class="btn btn-secondary mx-2" onchange="toggleColorBlindMode()">
            <option value="normal">Normal</option>
            <option value="protanopia">Protanopia</option>
			<option value="protanomalia">Protanomalia</option>
			<option value="deuteranopia">Deuteranopia</option>
			<option value="deuteranomalia">Deuteranomalia</option>
			<option value="tritanopia">Tritanopia</option>
			<option value="tritanomalia">Tritanomalia</option>
			<option value="achromatopsia">Achromatopsia</option>
			<option value="achromatomalia">Achromatomalia</option>
			<option value="blue-cone monochromacy">Blue-Cone Monochromacy</option>
			<option value="rod monochromacy">Rod Monochromacy</option>
			<option value="protan">Protan</option>
			<option value="deutan">Deutan</option>
			<option value="tritan">Tritan</option>
			<option value="total color blindness">Total Color Blindness</option>
            <!-- Outros tipos de daltonismo aqui -->
        </select>
        <button title="toggleThemeButton" id="toggleThemeButton" class="btn btn-secondary" onclick="toggleTheme()">
            <span id="themeIcon" class="bi bi-sun"></span>
        </button>
    </header>

    <!-- Conteúdo principal -->
    <main>
        <div class="container mt-5">
            <h2>Converter JSON para CSV - Campneus (Carros PRESTIGE)</h2>

            <!-- Adiciona o parágrafo com o link da base de dados -->
            <p class="text-light"><a href="https://drive-data-export.usercontent.google.com/download/bp8b55l2qs4tjvlt9cs1g41qe4m5afvg/6keiv5eratgfeppq7v3m2e5duvld8ak7/1712880000000/a5395ddc-4705-4e81-8133-5dc6b3463b2f/111424158906794601639/ADt3v-NU1vDvDkee8Ay8x3ng_rUhxvCWV9e8jFLmv8RYbJLZN5dyHb9rKdYHtfgkg0IglbI8vbO3ZCKjpWgZSdqEzvTJMhrsdG4fgo7lbXBKk3ec9PFTRMy49X68yPzDhd8lV79XETpk9jXDuJdoiEGcbmxQX_SUEkEk_d2c6tlAZDaQp1gcb4PUplZdf3um6l2XjERhlk4R5f-Lnm5jQFAunogEfU6rxvWJyz_9EBTzqovJfJIo6zFL4QYq6ZiPAB9CU005iHM3ZYFKEONtC6DocnMoJUaCFffAy-tWpKzE-h3fO3x3sMP2h0qwTkldRuop3D6ZqqzL?j=a5395ddc-4705-4e81-8133-5dc6b3463b2f&user=968479038308&i=0&authuser=0" target="_blank" class="text-light">>> Baixe a base de dados modelo <<</a></p>

            <div class="mb-3">
                <label for="jsonInput" class="form-label">Cole o JSON aqui:</label>
                <textarea class="form-control" id="jsonInput" rows="10"></textarea>
            </div>
            <div class="mb-3">
                <label for="jsonFile" class="form-label">Ou faça upload de arquivos JSON ou ZIP:</label>
                <input class="form-control" type="file" id="jsonFile" accept=".json,.zip" multiple>
            </div>
            <button onclick="convertJsonToCsv()" class="btn btn-primary">Converter</button>
            <button onclick="downloadCsv()" class="btn btn-success">Download</button>
            <button onclick="clearFields()" class="btn btn-secondary">Limpar</button>
        </div>

        <div class="container mt-3">
            <h3>Resultado CSV:</h3>
            <div id="resCsv"></div>
        </div>
        <footer class="footer">
            <p id="copyright">© Starley Interface 2017 - <span id="anoAtual"></span> | Versão 1.0.1</p>
        </footer>
    </main>

    <!-- Adicionando scripts do Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <script>
        var anoAtual = new Date().getFullYear();
        document.getElementById('anoAtual').innerHTML = anoAtual;
    </script>
    <script>
        let globalCsv = ''; // Variável para armazenar o CSV gerado globalmente
        let editor; // Referência ao editor Monaco

        // Inicializando currentTheme com o tema padrão (dark)
        let currentTheme = 'dark';

        function convertJsonToCsv() {
            const jsonInput = document.getElementById('jsonInput').value;
            const jsonFiles = document.getElementById('jsonFile').files;
            let filesProcessed = 0;

            if (jsonFiles.length > 0) {
                Array.from(jsonFiles).forEach(file => {
                    if (file.name.endsWith(".zip")) {
                        processZipFile(file); // Chama a função para processar arquivos ZIP
                    } else {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const json = JSON.parse(e.target.result);
                            processAndDisplayJson(json, ++filesProcessed === jsonFiles.length);
                        };
                        reader.readAsText(file);
                    }
                });
            } else if (jsonInput) {
                const json = JSON.parse(jsonInput);
                processAndDisplayJson(json, true);
            } else {
                alert('Por favor, insira um JSON ou faça upload de arquivos JSON ou ZIP.');
            }
        }

        // Função para processar arquivos ZIP
        function processZipFile(zipFile) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const zip = new JSZip();
                await zip.loadAsync(e.target.result);
                const fileNames = Object.keys(zip.files);

                let filesProcessed = 0;
                fileNames.forEach(async function(fileName) {
                    const file = zip.files[fileName];
                    if (!file.dir && file.name.endsWith('.json')) {
                        const jsonData = await file.async('text');
                        const json = cleanInvalidCharacters(JSON.parse(jsonData));
                        processAndDisplayJson(json, ++filesProcessed === fileNames.length);
                    }
                });
            };
            reader.readAsArrayBuffer(zipFile);
        }
		
		 function cleanInvalidCharacters(jsonString) {
			// Remove apenas caracteres de controle não gráficos, exceto tabulações (9), nova linha (10) e retorno de carro (13)
            return jsonString.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
        }
		
		 function replaceAccents(text) {
            const accents = "ÀÁÂÃÄÅàáâãäåÒÓÔÕÖØòóôõöøÈÉÊËèéêëÇçÌÍÎÏìíîïÙÚÛÜùúûüÑñ";
            const accentsOut = "AAAAAAaaaaaaOOOOOOooooooEEEEeeeeCcIIIIiiiiUUUUuuuuNn";
            return text.split('').map(char => {
                const index = accents.indexOf(char);
                return index !== -1 ? accentsOut[index] : char;
            }).join('');
        }

        function processAndDisplayJson(json, isFinalFile) {
            // Defina os cabeçalhos apenas uma vez
            if (!globalCsv) {
                const headers = "cdAutoSeg|cdAutoMarca|cdAutoModelo|cdAutoVersao|cdAutoAnos";
                globalCsv = headers + '\n';
            }

            let csv = '';
            // Expressão regular para remover espaços antes ou depois de um caractere pipe '|'
            const pattern = /\s*\|\s*/g;
            json.brand_models.forEach(model => {
                if ((model.model_segments.includes("PRESTIGE")) || (model.model_segments.includes("PREMIUM"))) {
                    model.model_versions.forEach(version => {
                        const row = [
                            model.model_segments.join('; '),
                            json.car_maker,
                            model.model_name,
                            version.car_version,
                            model.model_years_list.join('# ')
                        ].join('|').replace(pattern, '|');
                        csv += row + '\n';
                    });
                }
            });

            globalCsv += csv;

            if (isFinalFile) {
                editor.setValue(replaceAccents(globalCsv));
            }
        }

        function downloadCsv() {
            if (!globalCsv) {
                alert('Nenhum CSV para baixar. Por favor, gere o CSV primeiro.');
                return;
            }
            const blob = new Blob([replaceAccents(globalCsv)], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'superCars.csv';
            link.click();
        }

        function clearFields() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('jsonFile').value = '';
            editor.setValue(''); // Limpa o editor
            globalCsv = '';
        }

		function toggleTheme() {
			const body = document.body;
			const links = document.querySelectorAll('a');
			const paragraphs = document.querySelectorAll('p');
		
			if (currentTheme === 'dark') {
				// Remover classes de tema escuro e adicionar classes de tema claro
				body.classList.remove('bg-dark', 'text-light');
				body.classList.add('bg-light', 'text-dark');
				
				// Adicionar classes de tema claro aos links e parágrafos
				links.forEach(link => {
					link.classList.remove('link-light');
					link.classList.add('link-dark');
				});
		
				paragraphs.forEach(paragraph => {
					paragraph.classList.remove('text-light');
					paragraph.classList.add('text-dark');
				});
		
				// Atualizar ícone de tema
				document.getElementById('themeIcon').className = 'bi bi-moon';
				currentTheme = 'light';
			} else {
				// Remover classes de tema claro e adicionar classes de tema escuro
				body.classList.remove('bg-light', 'text-dark');
				body.classList.add('bg-dark', 'text-light');
				
				// Adicionar classes de tema escuro aos links e parágrafos
				links.forEach(link => {
					link.classList.remove('link-dark');
					link.classList.add('link-light');
				});
		
				paragraphs.forEach(paragraph => {
					paragraph.classList.remove('text-dark');
					paragraph.classList.add('text-light');
				});
		
				// Atualizar ícone de tema
				document.getElementById('themeIcon').className = 'bi bi-sun';
				currentTheme = 'dark';
			}
		}

		
		// Função para alternar o modo de acessibilidade
		function toggleAccessibility() {
			const body = document.body;
			const isAccessible = body.classList.contains('accessible-mode');
		
			if (isAccessible) {
				// Desativar modo de acessibilidade
				body.classList.remove('accessible-mode');
				// Restaurar configurações originais, como fonte padrão
				body.style.fontSize = '';
			} else {
				// Ativar modo de acessibilidade
				body.classList.add('accessible-mode');
				// Ajustar configurações, como aumentar o tamanho da fonte
				body.style.fontSize = '1.5rem';
			}
		}

		// Mapeamento dos filtros CSS para cada tipo de daltonismo
		const colorBlindFilters = {
			'normal': '',
			'protanopia': 'invert(0%) saturate(100%) hue-rotate(90deg) brightness(100%) contrast(100%)',
			'protanomalia': 'invert(0%) saturate(100%) hue-rotate(90deg) brightness(100%) contrast(100%)',
			'deuteranopia': 'invert(0%) saturate(100%) hue-rotate(180deg) brightness(100%) contrast(100%)',
			'deuteranomalia': 'invert(0%) saturate(100%) hue-rotate(180deg) brightness(100%) contrast(100%)',
			'tritanopia': 'invert(0%) saturate(100%) hue-rotate(270deg) brightness(100%) contrast(100%)',
			'tritanomalia': 'invert(0%) saturate(100%) hue-rotate(270deg) brightness(100%) contrast(100%)',
			'achromatopsia': 'grayscale(100%)',
			'achromatomalia': 'grayscale(80%)',
			'blue-cone monochromacy': 'grayscale(50%) saturate(50%)',
			'rod monochromacy': 'grayscale(100%)',
			'protan': 'grayscale(20%)',
			'deutan': 'grayscale(20%)',
			'tritan': 'grayscale(20%)',
			'total color blindness': 'grayscale(100%)',
		};
		
		// Função para alternar o modo de daltonismo
		function toggleColorBlindMode() {
			const body = document.body;
			const colorBlindSelect = document.getElementById('colorBlindSelect');
			const colorBlindType = colorBlindSelect.value;
		
			if (colorBlindFilters.hasOwnProperty(colorBlindType)) {
				// Aplica o filtro correspondente ao tipo de daltonismo escolhido
				body.style.filter = colorBlindFilters[colorBlindType];
				//alert(`Modo de daltonismo ajustado para: ${colorBlindType}`);
			} else {
				// Notifica o usuário se o tipo de daltonismo não for reconhecido
				alert('Tipo de daltonismo desconhecido. Por favor, tente novamente.');
			}
		}
		
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('resCsv'), {
                value: '',
                language: 'textplain',
                theme: 'vs-dark',
                readOnly: true,
                automaticLayout: true,
                lineNumbers: "on",
                wordWrap: 'on'
            });
        });

    </script>

</body>

</html>
